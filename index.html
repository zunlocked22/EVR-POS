<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EVR-VET OPTIONS CORPORATION ‚Äî POS (Fixed)</title>
  <meta name="theme-color" content="#27ae60"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- LINK TO EXTERNAL CSS (if you have it) -->
  <!-- If you prefer external CSS, you can move the <style> contents to styles.css -->
  <style>
    :root { --green:#27ae60; --blue:#2980b9; --bg:#f6f8f7; --text:#222; --gray:#ccc; }
    body{ font-family:system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; background:var(--bg); color:var(--text); padding:16px; }
    .pos-box{ background:#fff; border:1px solid #e8e8e8; border-radius:10px; box-shadow:0 3px 10px rgba(0,0,0,.06); padding:16px; }
    h1{ font-size:1.4rem; text-align:center; margin:0 0 16px; }
    table{ font-size:.95rem; }
    .right{text-align:right}
    td[contenteditable]{background:#fffef0}
    #receipt{display:none}
    #subtotalDisplay,#discountDisplay,#totalDisplay,#change{ font-weight:700; }
    .stat{ font-size:1.05rem; }

    /* ---------- Tidy Transaction History Table ---------- */
    #historyBody td, #historyBody th { vertical-align: top; padding: 6px 8px; }
    #historyModal .table { table-layout: fixed; width: 100%; }
    .history-items-preview {
      display: block;
      max-height: 2.8em;     /* ~2 lines */
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: normal;
      line-height: 1.4em;
    }
    #viewItemsModal .modal-body { max-height: 60vh; overflow:auto; }
    #historyModal th:nth-child(1), #historyModal td:nth-child(1) { width:120px; }
    #historyModal th:nth-child(2), #historyModal td:nth-child(2) { width:140px; }
    #historyModal th:nth-child(3), #historyModal td:nth-child(3) { width:160px; }
    #historyModal th:nth-child(4), #historyModal td:nth-child(4) { width:40%; min-width:220px; }
    #historyModal th:last-child, #historyModal td:last-child { width:200px; text-align:center; white-space:nowrap; }
    #historyBody .btn { white-space: nowrap; margin-left:4px; }

    /* ensure receipt never overlays */
    #receipt{ display:none !important; position:static !important; }
  </style>
</head>
<body>
<div class="pos-box">
  <h1>EVR-VET OPTIONS CORPORATION</h1>

  <div class="row g-2 align-items-center mb-2">
    <div class="col-12 col-md-auto"><input class="form-control" id="customerName" placeholder="Customer Name"></div>
    <div class="col-6 col-md-auto"><input class="form-control" id="barcode" placeholder="Scan/Enter Code" autofocus></div>
    <div class="col-6 col-md-auto" style="max-width:120px"><input class="form-control" type="number" id="quantity" placeholder="Qty" value="1" min="1"></div>

    <div class="col-6 col-md-auto">
      <select id="paymentMethod" class="form-control">
        <option value="Cash">Cash</option>
        <option value="GCash">GCash</option>
        <option value="Card">Card</option>
      </select>
    </div>
    <div class="col-6 col-md-auto" style="max-width:160px"><input class="form-control" type="number" id="cashInput" placeholder="Cash"></div>
    <div class="col-12 col-md-auto" style="max-width:220px"><input class="form-control d-none" id="paymentRef" placeholder="GCash/Card Ref No."></div>

    <div class="col-12 col-md-auto d-flex align-items-center gap-2">
      <label class="form-label m-0">Disc %</label>
      <input id="discountInput" class="form-control" style="max-width:90px" type="number" min="0" value="0">
      <div class="btn-group">
        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setDiscountPreset(5)">5%</button>
        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setDiscountPreset(10)">10%</button>
      </div>
    </div>

    <div class="col-12 col-lg d-flex flex-wrap gap-3 justify-content-lg-end">
      <div class="stat">Subtotal: ‚Ç±<span id="subtotalDisplay">0.00</span></div>
      <div class="stat text-danger">Less: ‚Ç±<span id="discountDisplay">0.00</span> <small id="discountPercentDisplay">(0%)</small></div>
      <div class="stat text-success">Total: ‚Ç±<span id="totalDisplay">0.00</span></div>
      <div class="stat" id="changeContainer">Change: ‚Ç±<span id="change">0.00</span></div>
    </div>

    <div class="col-12 d-flex flex-wrap gap-2 mt-2">
      <button type="button" class="btn btn-secondary" onclick="saveTransaction()">Save</button>
      <button type="button" class="btn btn-success" onclick="printReceipt()">üñ®Ô∏è Print Receipt</button>
      <button type="button" class="btn btn-outline-primary" onclick="toggleHistory()">üìú History</button>
      <button type="button" class="btn btn-info" onclick="showTopSuppliers()">üèÜ Top Suppliers</button>
      <button type="button" class="btn btn-danger" onclick="clearCart()">Clear</button>
      <button type="button" class="btn btn-outline-secondary" onclick="openProductsModal()">üßæ Manage Products</button>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-sm table-striped table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th>Code</th>
          <th>Name</th>
          <th>Qty</th>
          <th class="right">Price</th>
          <th class="right">Total</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="cartBody"></tbody>
    </table>
  </div>
</div>

<!-- Receipt container (unused visually) -->
<div id="receipt"><div id="receiptContent"></div></div>

<!-- HISTORY MODAL -->
<div class="modal fade" id="historyModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Transaction History</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex mb-2 gap-2 flex-wrap">
          <input class="form-control" id="searchHistory" placeholder="Search (customer, item, date, invoice, payment)" onkeyup="renderHistory()">
          <select class="form-control" id="historyBrandFilter" style="max-width:240px;" onchange="renderHistory()">
            <option value="">All Brands</option>
          </select>
          <button type="button" onclick="downloadTransactionHistory()" class="btn btn-success">Download</button>
          <button type="button" class="btn btn-danger" onclick="confirmClearAllHistory()">Clear All History</button>
        </div>
     <div class="table-responsive">
  <table class="table table-sm table-bordered table-striped align-middle">
    <thead class="table-light text-center">
      <tr>
        <th style="width: 120px;">Invoice #</th>
        <th style="width: 160px;">Date</th>
        <th style="width: 120px;">Customer</th>
        <th style="width: 300px;">Items</th>
        <th style="width: 100px;" class="text-end">Total</th>
        <th style="width: 100px;">Payment</th>
        <th style="width: 80px;">Ref</th>
        <th style="width: 100px;" class="text-end">Cash</th>
        <th style="width: 100px;" class="text-end">Change</th>
        <th style="width: 100px;" class="text-end">Discount</th>
        <th style="width: 200px;">Reason</th>
        <th style="width: 300px;">Action</th>
      </tr>
    </thead>
    <tbody id="historyBody"></tbody>
  </table>
</div>

      </div>
    </div>
  </div>
</div>

<!-- VIEW ITEMS MODAL -->
<div class="modal fade" id="viewItemsModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Invoice Items</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div id="viewItemsHeader" class="mb-2 small text-muted"></div>
        <div class="table-responsive">
          <table class="table table-sm table-bordered">
            <thead class="table-light"><tr><th>Code</th><th>Item</th><th class="right">Qty</th><th class="right">Price</th><th class="right">Total</th></tr></thead>
            <tbody id="viewItemsContent"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div>
    </div>
  </div>
</div>

<!-- ADMIN PASSWORD MODAL -->
<div class="modal fade" id="adminModal" tabindex="-1">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Admin Password</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div class="mb-2">Enter admin password to continue:</div>
        <input id="adminPasswordInput" type="password" class="form-control" placeholder="Password">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="adminConfirmBtn">Confirm</button>
      </div>
    </div>
  </div>
</div>

<!-- PRODUCTS MODAL -->
<div class="modal fade" id="productsModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Manage Products</h5><button type="button" class="btn btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div class="mb-3 d-flex gap-2 flex-wrap">
          <input id="prodBarcode" class="form-control" style="max-width:200px;" placeholder="Barcode / Code">
          <input id="prodName" class="form-control" style="max-width:320px;" placeholder="Product Name">
          <input id="prodBrand" class="form-control" style="max-width:200px;" placeholder="Brand / Supplier">
          <input id="prodPrice" class="form-control" style="max-width:140px;" type="number" placeholder="Price">
          <input id="prodStock" class="form-control" style="max-width:160px;" type="number" placeholder="Stock">
          <button type="button" id="addProdBtn" class="btn btn-success" onclick="addOrUpdateProduct()">‚ûï Add Product</button>

          <!-- Import / Template -->
          <input type="file" id="importFileInput" accept=".xlsx,.xls,.csv" class="d-none" />
          <button type="button" class="btn btn-outline-primary" onclick="triggerImport()">‚¨ÜÔ∏è Import (Excel/CSV)</button>
          <button type="button" class="btn btn-outline-secondary" onclick="downloadProductsTemplate()">üìÑ Template</button>
        </div>
        <div class="small mb-2">Tip: Scan a code in the main POS to auto-fill barcode here (then edit details).</div>
        <div class="table-responsive">
          <table class="table table-sm table-bordered align-middle">
            <thead class="table-light">
              <tr>
                <th>Code</th>
                <th>Name</th>
                <th>Brand</th>
                <th class="right">Price</th>
                <th class="right">Stock</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="productsBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- EDIT QTY MODAL -->
<div class="modal fade" id="editQtyModal" tabindex="-1">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Edit Quantity</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <input type="hidden" id="editQtyIndex">
        <label class="form-label">Quantity</label>
        <input id="editQtyInput" type="number" min="1" class="form-control" />
        <div class="form-text" id="editQtyHelp"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveEditQty()">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- TOP SUPPLIERS MODAL -->
<div class="modal fade" id="topSuppliersModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Top Suppliers (by Earnings)</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-sm table-bordered align-middle">
            <thead class="table-light">
              <tr>
                <th>#</th>
                <th>Brand / Supplier</th>
                <th class="right">QTY</th>
                <th>Total Earnings (‚Ç±)</th>
              </tr>
            </thead>
            <tbody id="topSuppliersBody"></tbody>
          </table>
        </div>
        <div class="small text-muted">Note: Earnings = Œ£(qty √ó price) across all transactions.</div>
      </div>
    </div>
  </div>
</div>
<!-- EDIT PRODUCT MODAL -->
<div class="modal fade" id="editProductModal" tabindex="-1">
  <div class="modal-dialog modal-md modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Product</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editProdCode">
        <div class="mb-2">
          <label class="form-label">Name</label>
          <input id="editProdName" class="form-control">
        </div>
        <div class="mb-2">
          <label class="form-label">Brand</label>
          <input id="editProdBrand" class="form-control">
        </div>
        <div class="mb-2">
          <label class="form-label">Price</label>
          <input id="editProdPrice" type="number" class="form-control">
        </div>
        <div class="mb-2">
          <label class="form-label">Stock</label>
          <input id="editProdStock" type="number" class="form-control">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveEditedProduct()">Save Changes</button>
      </div>
    </div>
  </div>
</div>


<!-- REFUND MODAL -->
<div class="modal fade" id="refundModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Process Refund</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div id="refundInfo" class="mb-2 small text-muted"></div>
        <div class="table-responsive">
          <table class="table table-sm table-bordered">
            <thead class="table-light"><tr><th>Item</th><th>Sold Qty</th><th>Refund Qty</th><th>Price</th><th>Refund Amount</th></tr></thead>
            <tbody id="refundItemsBody"></tbody>
          </table>
        </div>
        <div class="mb-2">
          <label class="form-label">Reason for refund (optional)</label>
          <input id="refundReason" class="form-control" placeholder="Customer returned item / damaged / wrong item">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="refundPrepareBtn">Request Admin to Confirm Refund</button>
      </div>
    </div>
  </div>
</div>

<!-- EDIT TRANSACTION MODAL -->
<div class="modal fade" id="editTransactionModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Edit Transaction (Admin)</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div id="editInfo" class="mb-2 small text-muted"></div>
        <div class="table-responsive">
          <table class="table table-sm table-bordered">
            <thead class="table-light"><tr><th>Item</th><th>Original Qty</th><th>New Qty</th><th>Price</th><th>Delta</th></tr></thead>
            <tbody id="editItemsBody"></tbody>
          </table>
        </div>
        <div class="mb-2">
          <label class="form-label">Edit Reason/Note</label>
          <input id="editReason" class="form-control" placeholder="Correction: wrong qty entered">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="editPrepareBtn">Request Admin to Confirm Edit</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- SheetJS (Excel import) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<!-- LINK TO EXTERNAL JS -->
<script src="pos.js"></script>
</body>
</html>
